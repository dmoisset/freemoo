<HTML>
<HEAD>
   <TITLE>Mapa de diseño de FreeMOO</TITLE>
</HEAD>
<BODY>
<H1>Mapa de diseño de FreeMOO</H1>

<H2>Organización general</H2>

<P>Los bloques principales de FreeMOO son:

<UL>
   <LI>"Shared": Las clases que están en este bloque son las que describen
       las reglas y la lógica del juego, las estructuras de datos, etc. Todo
       lo que hace al gameplay debría estar aquí adentro. A su vez, no debe
       ir aqui nada relativo a la representación gráfica, o a como se
       almacenan los datos en disco o por la red.
   <LI>"Server": Este cluster contiene un sistema que corre una implementación
       basada en red de FreeMOO. Esencialmente usa las clases de "Shared"
       (redefiniendo varias por herencia), y es capaz de transmitir el estado
       de instancias de estas a clientes que se conecten. El estado de los
       clientes tienen una copia que pueden ser incompletas o desactualizadas.
       De hecho siempre es incompleta, ya que el servidor solo transmite la
       información que el jugador en cada cliente puede saber.
   <LI>"Client": Este cluster contiene dos sistemas. FM_client es un cliente
       gráfico para conectarse al servidor. Esencialmente, muestra una
       representación de la información que el servidor envía, y permite al
       usuario enviar ordenes al servidor con una interfaz gráfica. dumb_client
       es un cliente que solo envía ordenes al servidor siguiendo un patrón
       hardcodeado (es un bot).
   <LI>"Data": Aqui hay archivos de datos, tanto tablas de datos para
       las clases de shared, como imagenes, animaciones y sonidos para el
       cliente.
   <LI>"Tools": Este es un conjunto de herramientas, que no hacen falta para
       correr el cliente o servidor, pero son necesarias para generar algunos
       de los archivos de datos. También hay mini-sistemas para
       component-testing
</UL>

<H2>Clases compartidas (shared)</H2>

<H3>Modelo de datos</H3>

<P>Las clases <A href="short/galaxy.html">GALAXY</A>,
<A href="short/star.html">STAR</A>,
<A href="short/planet.html">PLANET</A>,
<A href="short/colony.html">COLONY</A>,
<A href="short/fleet.html">FLEET</A>,
<A href="short/ship.html">SHIP</A>,
<A href="short/player_list.html">PLAYER_LIST</A>,
<A href="short/player.html">PLAYER</A>
son las que almacenan información de estado del juego. El árbol de la relación
"contiene a" es: 

<UL>
    <LI><A href="short/galaxy.html">GALAXY</A>: La galaxia (el terreno de juego). Contiene las estrellas y 
                todas las flotas en juego.<UL>
        <LI><A href="short/star.html">STAR</A>: Un sistema estelar con hasta 5 planetas en órbita.<UL>
            <LI><A href="short/planet.html">PLANET</A>: Un planeta, que puede tener una colonia.<UL>
                <LI><A href="short/colony.html">COLONY</A>: Una colonia.
            </UL>
        </UL>
        <LI><A href="short/fleet.html">FLEET</A>: Contiene al menos una nave<UL>
            <LI><A href="short/ship.html">SHIP</A>: En realidad se usan instancias de los hijos efectivos
                      de <A href="short/ship.html">SHIP</A> (<A href="short/starship.html">STARSHIP</A>, <A href="short/colony_ship.html">COLONY_SHIP</A>)
        </UL>
    </UL>
    <LI><A href="short/player_list.html">PLAYER_LIST</A>: Contiene a todos los jugadores.<UL>
        <LI><A href="short/player.html">PLAYER</A>: Cada jugador.
    </UL>
</UL>

<P>Estas clases tienen cada una atributos pertinentes que las describen
(por ej.: una estrella tiene nombre, color, etc.). Algunos atributos son
enumeraciónes, cuyas constantes pueden encontrarse en <A href="short/map_constants.html">MAP_CONSTANTS</A> (para
<A href="short/star.html">STAR</A> y <A href="short/planet.html">PLANET</A>),
<A href="short/ship_constants.html">SHIP_CONSTANTS</A> (para <A href="short/ship.html">SHIP</A>)
o <A href="short/player_constants.html">PLAYER_CONSTANTS</A> (para <A href="short/player.html">PLAYER</A>).

<P>Además de la relación
de inclusión mostrada arriba, hay relaciones cruzadas (las colonias y flotas
tienen por ej.: un owner, que es un jugador, y un jugador tiene la lista de
flotas que le pertenecen). Sin embargo, la estructura de arriba es la forma
oficial de llegar a toda la información. Todas las instancias de las clases
mostradas arriba deberían ser accesibles a través de ese árbol

<P>Las clases anteriores que son contenedores incluyén métodos para manipular
los elementos contenidos, y a veces para manipular sus atributos (en otros
casos hay atributos que solo pueden fijarse en la creación).

<H4>Otras clases del modelo de datos</H4>

<P><FONT color="blue">[TODO: poner links en todas las clases]</FONT>

<P>POSITIONAL abstrae un punto, y es heredada por aquellas clases que tienen
una posición en la galaxy (en este momento, STAR y FLEET). La idea de
POSITIONAL, además de ofrecer atributos comunes, es abstraer el espacio de
coordenadas, para que sea fácil cambiar por ejemplo de un mapa 2D a uno 3D,
o a un mapa 2D cilíndrico, etc. Cuando hace falta crear un punto con
coordenadas dadas puede usarse COORDS. Cuando solo interesa obtener una
proyección al plano de la coordenada (para dibujar mapas, por ejemplo), 
corresponde usar PROJECTION, que toma un POSITIONAL, lo proyecta, y devuelve
un par de coordenadas (x,y) en el plano.

<P>ORBITING contiene los atributos comunes de objetos que pueden estar en
orbita en un sistema (actualmente, PLANET y FLEET). <FONT color="red">
[FIXME: revisar si realmente hace falta].</FONT>

<P>La clase POD no está siendo usada en este momento, pero eventualmente
iría incluida en STARSHIP. Modela un sistema de armas.

<H3>Inicio del juego</H3>

<P>El juego se encapsula en una instancia de la clase GAME, que contiene
una GALAXY, una PLAYER_LIST, y un GAME_STATUS (clase para describir
propiedades globales de la partida). Con esto, desde GAME se puede acceder
a todo el estado del juego.

<P>Una vez creado un game con un conjunto de opciones (que se pasan en
una instancia de SERVER_OPTIONS <FONT color="red">[FIXME: el nombre debería ser GAME_OPTIONS]</FONT>),
se agregan jugadores al GAME con add_player, y cuando cada jugador esta listo
para empezar (luego de configurar raza, color, etc....) se invoca a
set_player_ready. Las invocaciones de add_player y set_player_ready pueden
sucederse en cualquier orden (siempre y cuando para un jugador dado se invoque
add_player antes de set_player_ready).

<P>En el momento en que el juego esta lleno, y todos los jugadores están
listos (i.e., se invoco a set_player), se inicializa el estado del juego.
El mapa es generado con un MAP_GENERATOR que hay dentro de GAME.

<P><FONT color="blue">[TODO: hablar un poco de las clases para generar
mapas.]</FONT>

<H3>Reglas del juego</H3>

<P>En las clases en shared esta toda la implementación de las reglas del
juego.

<P>Cada jugador da las ordenes durante el turno llamando a los métodos
apropiados de las clases del módelo de datos (por ejemplo, set_destination
de FLEET si quiere mover una de sus flotas, o set_production de COLONY si
quiere decidir cambiar de producción).

<P>Al final del turno de cada jugador, se invoca a end_turn de GAME.
Cuando el ultimo_jugador invoca end_turn, se invoca automáticante a new_turn
que efectúa todo el proceso de avance de turno. GAME contiene las reglas
generales de paso de turno. Los detalles están en métodos de las clases del
modelo de datos, que son invocados directa o indirectamente por new_turn.
Por ejemplo, la producción esta modelada en COLONY, el viaje interestelar
en FLEET, etc.

<H3>Miscelaneas</H3>

Aqui se describen varias clases útiles adicionales que hay en
"shared". Todas ellas podrían moverse eventualmente fuera de FreeMOO.

<UL>
    <LI>COMMENTED_TEXT_FILE: Esta clase permite leer un archivo de texto,
        ignorando lineas en blanco y comentarios (iniciados con '#') de
        forma automática.
    <LI>PROBABILITY_TABLE, FINITE_PTABLE: Esta clase modela conjuntos
        finitos de eventos, con
        probabilidades asociadas de que ocurra uno en un momento dado.
    <LI>GETTEXT: Aun sin impplementar, esta clase debería ser una interfaz
        a la biblioteca gettext de GNU.
    <LI>PKG_SYSTEM, PKG_USER: En estas clases esta el sistema de
        empaquetamiento (un mecanismo para acceder a archivos que
        pueden estar en el filesystem o empaquetados en otros archivos).
        La documentación de estos módulos esta en 
        <A href="pkg-system.txt">pkg-system.txt</A>.
    <LI>TEXT_FILE_READ_EXPORTABLE: equivalente a la clase standard
        TEXT_FILE_READ (hereda de ella), pero permite acceder al FILE *
        interno para pasarselo a rutinas de C (por eso "exportable").
</UL>

Además, en shared esta la clase PROTOCOL, con constantes usadas en el cliente
y en el servidor para las comunicaciones, pero que no estan relacionadas con
las reglas del juego. <FONT color="red">[FIXME: no debería estar en shared.]</FONT>

<H2>Arquitectura cliente/servidor</H2>

<P>La versión en red del juego esta basado en un modelo client/server. El
servidor mantiene todo el estado, y el cliente recibe actualizaciones de la
parte del estado que puede ver.

<P>El mecanismo para mantener sincronizado el cliente con el servidor es a
través de pares SERVICE/SUBSCRIBER, comunicandose via sockets con el módulo
netservices. Se definen para las clases del modelo de datos herederos en el
servidor (llamados S_x para la clase x) que también heredan de SERVICE.
Paralelamente, en el cliente se definen herederos de las clases del modelo
de datos (llamadas C_x para la clase x). El servidor registra los servicios,
y el cliente se va suscribiendo.

<P>La siguiente tabla muestra para cada clase del modelo de datos los
servicios que propagan su estado:

<TABLE border="1">
<TR><TD><B>Clase</B></TD><TD><B>Servicio</B></TD><TD><B>Comentarios</B></TD></TR>

<TR><TD>GAME_STATUS</TD><TD>"game_status"</TD></TR>

<TR><TD>PLAYER_LIST</TD><TD>"players_list"</TD></TR>

<TR><TD>PLAYER</TD><TD>"players_list"</TD><TD>Only basic description (name, status and color)</TD></TR>

<TR><TD rowspan="2">GALAXY</TD><TD>"galaxy"</TD><TD>Star list</TD></TR>
<TR>                           <TD>n+":scanner"</TD><TD>Fleets seen by n (not including own)</TD></TR>

<TR><TD rowspan="2">STAR</TD><TD>"galaxy"</TD><TD>Only public description (position, color, size)</TD></TR>
<TR>                         <TD>"star"+id</TD><TD>Description for players who visited the star</TD></TR>

<TR><TD>PLANET</TD><TD>"star"+id</TD></TR>

<TR><TD>FLEET</TD><TD>"n+":scanner</TD><TD>Only public details</TD></TR>

<TR><TD>SHIP</TD><TD>"n+":scanner</TD><TD>Only size and picture</TD></TR>

</TABLE>

<P>Puede encontrarse una descripción del formato de mensaje para cada
servicio en <A href="services-fm.txt">services-fm.txt</A>

<P><FONT color="red">[Faltan: descripción completa del jugador.
Flotas/naves del jugador.
Colonias (propias y ajenas).
]</FONT>

<P>Los comandos del cliente al servidor se transmiten en mensajes especiales.
La lista de esos mensajes puede encontrarse en 
<A href="protocol-fm.txt">protocol-fm.txt</A>. Ese documento también
contiene descripción de algunos mensajes especiales del servidor al cliente,
no relacionados con servicios (en este momento, solo relacionados con el
proceso de autenticación).

<P><FONT color="blue">[TODO: sección incompleta]</FONT>.


</BODY>
</HTML>